<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1242px" preserveAspectRatio="none" style="width:997px;height:1242px;" version="1.1" viewBox="0 0 997 1242" width="997px" zoomAndPan="magnify"><defs><filter height="300%" id="f179lt731eyros" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="134.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="408.5" y="79.7988"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="307.1055" style="stroke:#A80036;stroke-width:1.0;" width="10" x="408.5" y="882.4941"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="146.2422" style="stroke:#A80036;stroke-width:1.0;" width="10" x="413.5" y="919.8047"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="318.1055" style="stroke:#A80036;stroke-width:1.0;" width="10" x="573.5" y="214.6621"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="280.7949" style="stroke:#A80036;stroke-width:1.0;" width="10" x="578.5" y="251.9727"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="79.6211" style="stroke:#A80036;stroke-width:1.0;" width="10" x="583.5" y="318.5938"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="305.416" style="stroke:#A80036;stroke-width:1.0;" width="10" x="573.5" y="577.0781"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="94.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="578.5" y="643.6992"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="141.2422" style="stroke:#000000;stroke-width:2.0;" width="392.5" x="546.5" y="271.9727"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="156.5527" style="stroke:#000000;stroke-width:2.0;" width="377.5" x="546.5" y="597.0781"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="141.2422" style="stroke:#000000;stroke-width:2.0;" width="516.5" x="62" y="939.8047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="413" x2="413" y1="40.4883" y2="1198.5996"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="578.5" x2="578.5" y1="40.4883" y2="1198.5996"/><rect fill="#FEFECE" filter="url(#f179lt731eyros)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="47" x="388" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="33" x="395" y="25.5352">Alice</text><rect fill="#FEFECE" filter="url(#f179lt731eyros)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="47" x="388" y="1197.5996"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="33" x="395" y="1218.1348">Alice</text><rect fill="#FEFECE" filter="url(#f179lt731eyros)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="40" x="556.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26" x="563.5" y="25.5352">Bob</text><rect fill="#FEFECE" filter="url(#f179lt731eyros)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="40" x="556.5" y="1197.5996"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26" x="563.5" y="1218.1348">Bob</text><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="134.8633" style="stroke:#A80036;stroke-width:1.0;" width="10" x="408.5" y="79.7988"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="307.1055" style="stroke:#A80036;stroke-width:1.0;" width="10" x="408.5" y="882.4941"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="146.2422" style="stroke:#A80036;stroke-width:1.0;" width="10" x="413.5" y="919.8047"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="318.1055" style="stroke:#A80036;stroke-width:1.0;" width="10" x="573.5" y="214.6621"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="280.7949" style="stroke:#A80036;stroke-width:1.0;" width="10" x="578.5" y="251.9727"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="79.6211" style="stroke:#A80036;stroke-width:1.0;" width="10" x="583.5" y="318.5938"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="305.416" style="stroke:#A80036;stroke-width:1.0;" width="10" x="573.5" y="577.0781"/><rect fill="#FFFFFF" filter="url(#f179lt731eyros)" height="94.9316" style="stroke:#A80036;stroke-width:1.0;" width="10" x="578.5" y="643.6992"/><line style="stroke:#A80036;stroke-width:1.0;" x1="413.5" x2="460.5" y1="66.7988" y2="66.7988"/><line style="stroke:#A80036;stroke-width:1.0;" x1="460.5" x2="460.5" y1="66.7988" y2="79.7988"/><line style="stroke:#A80036;stroke-width:1.0;" x1="419.5" x2="460.5" y1="79.7988" y2="79.7988"/><polygon fill="#A80036" points="429.5,75.7988,419.5,79.7988,429.5,83.7988,425.5,79.7988" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="425.5" y="62.0566">prepare message</text><path d="M21,97.7988 L21,183.7988 L399,183.7988 L399,107.7988 L389,97.7988 L21,97.7988 " fill="#FBFB77" filter="url(#f179lt731eyros)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M389,97.7988 L389,107.7988 L399,107.7988 L389,97.7988 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="27" y="115.3672">Prepare ciphertext message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="357" x="27" y="130.6777">messageKey, newSendingChain = KDF_CK(sendingChain)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278" x="27" y="145.9883">ciphertext = Encrypt(messageKey, plaintext)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="27" y="161.2988">mac = HMAC(messageKey, IkA, IkB, ciphertext)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="325" x="27" y="176.6094">ciphertextMessage = {ciphertext, mac, ratchetKeyA}</text><polygon fill="#A80036" points="561.5,210.6621,571.5,214.6621,561.5,218.6621,565.5,214.6621" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="413.5" x2="567.5" y1="214.6621" y2="214.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="420.5" y="209.9199">send message</text><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="630.5" y1="238.9727" y2="238.9727"/><line style="stroke:#A80036;stroke-width:1.0;" x1="630.5" x2="630.5" y1="238.9727" y2="251.9727"/><line style="stroke:#A80036;stroke-width:1.0;" x1="589.5" x2="630.5" y1="251.9727" y2="251.9727"/><polygon fill="#A80036" points="599.5,247.9727,589.5,251.9727,599.5,255.9727,595.5,251.9727" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="595.5" y="234.2305">decrypt message</text><path d="M546.5,271.9727 L886.5,271.9727 L886.5,278.9727 L876.5,288.9727 L546.5,288.9727 L546.5,271.9727 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="141.2422" style="stroke:#000000;stroke-width:2.0;" width="392.5" x="546.5" y="271.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="295" x="561.5" y="285.541">RatchetKeyA is different for receiving chain</text><line style="stroke:#A80036;stroke-width:1.0;" x1="588.5" x2="635.5" y1="305.5938" y2="305.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="635.5" x2="635.5" y1="305.5938" y2="318.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="594.5" x2="635.5" y1="318.5938" y2="318.5938"/><polygon fill="#A80036" points="604.5,314.5938,594.5,318.5938,604.5,322.5938,600.5,318.5938" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="600.5" y="300.8516">rotate receiving chain</text><path d="M598,336.5938 L598,376.5938 L925,376.5938 L925,346.5938 L915,336.5938 L598,336.5938 " fill="#FBFB77" filter="url(#f179lt731eyros)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M915,336.5938 L915,346.5938 L925,346.5938 L915,336.5938 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="243" x="604" y="354.1621">secret = DH(ratchetKeyB, RatchetKeyA)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="604" y="369.4727">newRoot, newReceivingChain = KDF(root, secret)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="593.5" x2="635.5" y1="397.2148" y2="397.2148"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="635.5" x2="635.5" y1="397.2148" y2="410.2148"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="588.5" x2="635.5" y1="410.2148" y2="410.2148"/><polygon fill="#A80036" points="598.5,406.2148,588.5,410.2148,598.5,414.2148,594.5,410.2148" style="stroke:#A80036;stroke-width:1.0;"/><path d="M593,425.2148 L593,511.2148 L988,511.2148 L988,435.2148 L978,425.2148 L593,425.2148 " fill="#FBFB77" filter="url(#f179lt731eyros)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M978,425.2148 L978,435.2148 L988,435.2148 L978,425.2148 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="599" y="442.7832">Decrypt ciphertext message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374" x="599" y="458.0938">messageKey, newReceivingChain = KDF_CK(receivingChain)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="361" x="599" y="473.4043">calculatedMac = HMAC(messageKey, IkA, IkB, Ciphertext)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="599" y="488.7148">COMPARE(calculatedMac, Mac)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="599" y="504.0254">plaintext = Decrypt(messageKey, Ciphertext)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="588.5" x2="630.5" y1="531.7676" y2="531.7676"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="630.5" x2="630.5" y1="531.7676" y2="544.7676"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="583.5" x2="630.5" y1="544.7676" y2="544.7676"/><polygon fill="#A80036" points="593.5,540.7676,583.5,544.7676,593.5,548.7676,589.5,544.7676" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="578.5" x2="625.5" y1="564.0781" y2="564.0781"/><line style="stroke:#A80036;stroke-width:1.0;" x1="625.5" x2="625.5" y1="564.0781" y2="577.0781"/><line style="stroke:#A80036;stroke-width:1.0;" x1="584.5" x2="625.5" y1="577.0781" y2="577.0781"/><polygon fill="#A80036" points="594.5,573.0781,584.5,577.0781,594.5,581.0781,590.5,577.0781" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="590.5" y="559.3359">prepare message</text><path d="M546.5,597.0781 L786.5,597.0781 L786.5,604.0781 L776.5,614.0781 L546.5,614.0781 L546.5,597.0781 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="156.5527" style="stroke:#000000;stroke-width:2.0;" width="377.5" x="546.5" y="597.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="195" x="561.5" y="610.6465">receiving chain has changed</text><line style="stroke:#A80036;stroke-width:1.0;" x1="583.5" x2="630.5" y1="630.6992" y2="630.6992"/><line style="stroke:#A80036;stroke-width:1.0;" x1="630.5" x2="630.5" y1="630.6992" y2="643.6992"/><line style="stroke:#A80036;stroke-width:1.0;" x1="589.5" x2="630.5" y1="643.6992" y2="643.6992"/><polygon fill="#A80036" points="599.5,639.6992,589.5,643.6992,599.5,647.6992,595.5,643.6992" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="129" x="595.5" y="625.957">rotate sending chain</text><path d="M593,661.6992 L593,716.6992 L910,716.6992 L910,671.6992 L900,661.6992 L593,661.6992 " fill="#FBFB77" filter="url(#f179lt731eyros)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M900,661.6992 L900,671.6992 L910,671.6992 L900,661.6992 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="599" y="679.2676">newRatchetKeyB = Curve()</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="271" x="599" y="694.5781">secret = DH(newRatchetKeyB, RatchetKeyA)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="599" y="709.8887">newRoot, newSendingChain = KDF(root, secret)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="588.5" x2="630.5" y1="737.6309" y2="737.6309"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="630.5" x2="630.5" y1="737.6309" y2="750.6309"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="583.5" x2="630.5" y1="750.6309" y2="750.6309"/><polygon fill="#A80036" points="593.5,746.6309,583.5,750.6309,593.5,754.6309,589.5,750.6309" style="stroke:#A80036;stroke-width:1.0;"/><path d="M588,765.6309 L588,851.6309 L966,851.6309 L966,775.6309 L956,765.6309 L588,765.6309 " fill="#FBFB77" filter="url(#f179lt731eyros)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M956,765.6309 L956,775.6309 L966,775.6309 L956,765.6309 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177" x="594" y="783.1992">Prepare ciphertext message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="357" x="594" y="798.5098">messageKey, newSendingChain = KDF_CK(sendingChain)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="278" x="594" y="813.8203">ciphertext = Encrypt(messageKey, plaintext)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="594" y="829.1309">mac = HMAC(messageKey, IkA, IkB, ciphertext)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="323" x="594" y="844.4414">ciphertextMessage = {ciphertext, mac, ratchetKeyB}</text><polygon fill="#A80036" points="429.5,878.4941,419.5,882.4941,429.5,886.4941,425.5,882.4941" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="423.5" x2="577.5" y1="882.4941" y2="882.4941"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="435.5" y="877.752">send message</text><line style="stroke:#A80036;stroke-width:1.0;" x1="418.5" x2="465.5" y1="906.8047" y2="906.8047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="465.5" x2="465.5" y1="906.8047" y2="919.8047"/><line style="stroke:#A80036;stroke-width:1.0;" x1="424.5" x2="465.5" y1="919.8047" y2="919.8047"/><polygon fill="#A80036" points="434.5,915.8047,424.5,919.8047,434.5,923.8047,430.5,919.8047" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="430.5" y="902.0625">decrypt message</text><path d="M62,939.8047 L400,939.8047 L400,946.8047 L390,956.8047 L62,956.8047 L62,939.8047 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="141.2422" style="stroke:#000000;stroke-width:2.0;" width="516.5" x="62" y="939.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="293" x="77" y="953.373">RatchetKeyB is different for receiving chain</text><line style="stroke:#A80036;stroke-width:1.0;" x1="423.5" x2="465.5" y1="978.4258" y2="978.4258"/><line style="stroke:#A80036;stroke-width:1.0;" x1="465.5" x2="465.5" y1="978.4258" y2="991.4258"/><line style="stroke:#A80036;stroke-width:1.0;" x1="424.5" x2="465.5" y1="991.4258" y2="991.4258"/><polygon fill="#A80036" points="434.5,987.4258,424.5,991.4258,434.5,995.4258,430.5,991.4258" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="136" x="430.5" y="973.6836">rotate receiving chain</text><path d="M72,1004.4258 L72,1044.4258 L399,1044.4258 L399,1014.4258 L389,1004.4258 L72,1004.4258 " fill="#FBFB77" filter="url(#f179lt731eyros)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M389,1004.4258 L389,1014.4258 L399,1014.4258 L389,1004.4258 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="243" x="78" y="1021.9941">secret = DH(ratchetKeyA, RatchetKeyB)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="78" y="1037.3047">newRoot, newReceivingChain = KDF(root, secret)</text><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="423.5" x2="465.5" y1="1065.0469" y2="1065.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="465.5" x2="465.5" y1="1065.0469" y2="1078.0469"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="418.5" x2="465.5" y1="1078.0469" y2="1078.0469"/><polygon fill="#A80036" points="428.5,1074.0469,418.5,1078.0469,428.5,1082.0469,424.5,1078.0469" style="stroke:#A80036;stroke-width:1.0;"/><path d="M5,1093.0469 L5,1179.0469 L400,1179.0469 L400,1103.0469 L390,1093.0469 L5,1093.0469 " fill="#FBFB77" filter="url(#f179lt731eyros)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M390,1093.0469 L390,1103.0469 L400,1103.0469 L390,1093.0469 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="11" y="1110.6152">Decrypt ciphertext message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="374" x="11" y="1125.9258">messageKey, newReceivingChain = KDF_CK(receivingChain)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="361" x="11" y="1141.2363">calculatedMac = HMAC(messageKey, IkA, IkB, Ciphertext)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="11" y="1156.5469">COMPARE(calculatedMac, Mac)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="282" x="11" y="1171.8574">plaintext = Decrypt(messageKey, Ciphertext)</text><!--MD5=[82b61cfdc664dbfa4c3ae54c9b47ac09]
@startuml

participant Alice
participant Bob

Alice -> Alice: prepare message
activate Alice

note left of Alice
Prepare ciphertext message:
messageKey, newSendingChain = KDF_CK(sendingChain)
ciphertext = Encrypt(messageKey, plaintext)
mac = HMAC(messageKey, IkA, IkB, ciphertext)
ciphertextMessage = {ciphertext, mac, ratchetKeyA}
end note

Alice -> Bob: send message
deactivate Alice
activate Bob
Bob -> Bob: decrypt message
activate Bob

group RatchetKeyA is different for receiving chain
Bob -> Bob: rotate receiving chain
activate Bob
note right of Bob
secret = DH(ratchetKeyB, RatchetKeyA)
newRoot, newReceivingChain = KDF(root, secret)
end note
return
end

note right of Bob
Decrypt ciphertext message:
messageKey, newReceivingChain = KDF_CK(receivingChain)
calculatedMac = HMAC(messageKey, IkA, IkB, Ciphertext)
COMPARE(calculatedMac, Mac)
plaintext = Decrypt(messageKey, Ciphertext)
end note

return
deactivate Bob

Bob -> Bob: prepare message
activate Bob
group receiving chain has changed
Bob -> Bob: rotate sending chain
activate Bob
note right of Bob
newRatchetKeyB = Curve()
secret = DH(newRatchetKeyB, RatchetKeyA)
newRoot, newSendingChain = KDF(root, secret)
end note
return
end

note right of Bob
Prepare ciphertext message:
messageKey, newSendingChain = KDF_CK(sendingChain)
ciphertext = Encrypt(messageKey, plaintext)
mac = HMAC(messageKey, IkA, IkB, ciphertext)
ciphertextMessage = {ciphertext, mac, ratchetKeyB}
end note

Bob -> Alice: send message
deactivate Bob
activate Alice

Alice -> Alice: decrypt message
activate Alice

group RatchetKeyB is different for receiving chain
Alice -> Alice: rotate receiving chain
note left of Alice
secret = DH(ratchetKeyA, RatchetKeyB)
newRoot, newReceivingChain = KDF(root, secret)
end note
return
end

note left of Alice
Decrypt ciphertext message:
messageKey, newReceivingChain = KDF_CK(receivingChain)
calculatedMac = HMAC(messageKey, IkA, IkB, Ciphertext)
COMPARE(calculatedMac, Mac)
plaintext = Decrypt(messageKey, Ciphertext)
end note

@enduml

PlantUML version 1.2021.01(Tue Feb 02 10:55:08 MSK 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: BY
--></g></svg>